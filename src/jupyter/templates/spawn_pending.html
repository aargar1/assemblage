<!--
Copyright (C) 2026-present Aarav Garg.

This program is free software: you can redistribute it and/or modify
it under the terms of the Server Side Public License, version 1,
as published by MongoDB, Inc.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
Server Side Public License for more details.

You should have received a copy of the Server Side Public License
along with this program. If not, see
<http://www.mongodb.com/licensing/server-side-public-license>.
-->

{% extends "page.html" %}

{% block stylesheet %}
{{ super() }}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">

<style>
  body {
    background: #000;
    color: #fff;
    font-family: 'Space Mono', monospace;
  }

  .pending-panel {
    max-width: 720px;
    margin: 80px auto;
    padding: 40px;
    border: 1px solid #fff;
    box-shadow: 0 0 15px rgba(128,128,128,0.3);
  }

  h1 {
    font-size: 1.2rem;
    letter-spacing: 2px;
    border-bottom: 1px solid #fff;
    padding-bottom: 8px;
    margin-bottom: 20px;
    text-transform: uppercase;
  }

  .status-text {
    font-size: 0.85rem;
    color: #ccc;
    margin-bottom: 20px;
  }

  .progress {
    height: 18px;
    background: #111;
    border: 1px solid #444;
    border-radius: 0;
  }

  .progress-bar {
    background: #fff;
    color: #000;
    font-size: 0.65rem;
    line-height: 18px;
    font-weight: bold;
    transition: width 0.3s linear;
  }

  .progress-bar-danger {
    background: #ff5555 !important;
    color: #000;
  }

  #progress-message {
    margin-top: 15px;
    font-size: 0.75rem;
    color: #aaa;
    min-height: 1.2em;
  }

  details {
    margin-top: 30px;
    font-size: 0.7rem;
  }

  summary {
    cursor: pointer;
    color: #aaa;
    letter-spacing: 1px;
    text-transform: uppercase;
  }

  #progress-log {
    margin-top: 10px;
    padding: 10px;
    background: #050505;
    border: 1px solid #333;
    max-height: 240px;
    overflow-y: auto;
  }

  .progress-log-event {
    margin-bottom: 6px;
    color: #888;
  }
</style>
{% endblock %}

{% block main %}
<div class="pending-panel">

  <h1>Initializing Server</h1>

  {% block message %}
  <div class="status-text">
    Establishing execution environment.<br>
    This may take a moment.
  </div>
  {% endblock message %}

  <div class="progress">
    <div id="progress-bar"
         class="progress-bar"
         role="progressbar"
         aria-valuenow="0"
         aria-valuemin="0"
         aria-valuemax="100"
         style="width: 0%;">
      <span class="visually-hidden">
        <span id="sr-progress">0%</span> Complete
      </span>
    </div>
  </div>

  <div id="progress-message"></div>

  <details id="progress-details">
    <summary>Event Log</summary>
    <div id="progress-log"></div>
  </details>

</div>
{% endblock main %}

{% block script %}
{{ super() }}
<script type="text/javascript">
require(["jquery"], function($) {

  var evtSource = new EventSource("{{ progress_url }}");
  var progressMessage = $("#progress-message");
  var progressBar = $("#progress-bar");
  var srProgress = $("#sr-progress");
  var progressLog = $("#progress-log");

  evtSource.onmessage = function(e) {
    var evt = JSON.parse(e.data);
    console.log(evt);

    if (evt.progress !== undefined) {
      var progText = evt.progress.toString();
      progressBar.attr('aria-valuenow', progText);
      srProgress.text(progText + '%');
      progressBar.css('width', progText + '%');
    }

    var html_message;
    if (evt.html_message !== undefined) {
      progressMessage.html(evt.html_message);
      html_message = evt.html_message;
    } else if (evt.message !== undefined) {
      progressMessage.text(evt.message);
      html_message = progressMessage.html();
    }

    if (html_message) {
      progressLog.append(
        $("<div>")
          .addClass('progress-log-event')
          .html(html_message)
      );
      progressLog.scrollTop(progressLog[0].scrollHeight);
    }

    if (evt.ready) {
      evtSource.close();
      window.location.reload();
    }

    if (evt.failed) {
      evtSource.close();
      progressBar.addClass('progress-bar-danger');
      $('#progress-details').prop('open', true);
    }
  };

  window._jupyterhub_page_loaded = true;
});
</script>
{% endblock script %}

